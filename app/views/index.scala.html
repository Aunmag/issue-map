@views.html.base() {
    <div id="app">
        <div class="row control-block">
            <div class="menu-container col-3">
                <div v-bind:style="cardStyle" class="card card-default col-12 float-left" id='menu'>
                    @views.html.map.menu()
                </div>
            </div>
            <div class="view-container col-9">
                <div v-bind:style="viewStyle" class="card card-default col-12 float-right" id="view-panel" v-if="visibleViewPanel">
                    <a class="btn close-view" v-on:click="toggleViewPanel"><i class="fas fa-times"></i></a>
                    @views.html.issue.list()
                </div>
            </div>
            <a class="btn btn-open-view" v-on:click="openView('list')"><i class="fas fa-bars"></i> Меню</a>
            <a class="btn btn-access-admin" v-on:click="getAccess('Admin')"><i class="fas fa-user-cog"></i></a>
            <a class="btn btn-access-user" v-on:click="getAccess('User')"><i class="fas fa-user-alt"></i></a>
        </div>
        <div v-bind:style="mapStyle" id="map"></div>
        <div id="form-container">
            @views.html.issue.create()
        </div>
    </div>
    <script>
        var vm = new Vue({
            el: '#app',
            data: {
                cardStyle: {
                    height: null
                },
                mapStyle: {
                    height: null
                },
                viewStyle: {
                    height: null
                },
                issues: [],
                popup : null,
                layer : null,
                map : null,
                visibleMenu : true,
                drawMode : false,
                group : null,
                zoom : null,
                visibleViewPanel: false,
                issueForm: {
                    lat: 0,
                    lon: 0
                }
            },
            methods: {
                send: function (url, type, date, callback, header) {
                    var unindexed_array = date.serializeArray();
                    var indexed_array = {};

                    $.map(unindexed_array, function(n, i) {
                        indexed_array[n['name']] = n['value'];
                    });

                    if (!header) {
                        header = {
                            "Content-Type": "application/json"
                        }
                    }

                    $.ajax({
                        url: url,
                        type: type,
                        data: JSON.stringify(indexed_array),
                        headers: header,
                        dataType: 'json',
                        success: callback
                    });
                },
                drawModeEnable: function() {
                    this.drawMode = true;
                    L.DomUtil.addClass(this.map._container,'crosshair-cursor-draw');
                },
                getForm: function(latlng) {
                    this.issueForm.lat = latlng.lat;
                    this.issueForm.lon = latlng.lng;
                    $('#form-container .modal').modal();
                },
                createIssue: function() {
                    this.send('@api.v1.routes.IssueController.create()', 'POST', $('#createIssueForm'))
                },
                showCoordinates: function(e) {
                    alert(e.latlng);
                },
                pastePoint: function(e) {
                    if (this.drawMode) {
                        this.newMarker(e.latlng, 'Новая метка', 'new');
                        this.drawMode = false;
                        L.DomUtil.removeClass(this.map._container,'crosshair-cursor-draw');
                    }
                },
                toggleViewPanel: function(e) {
                    this.visibleViewPanel = !this.visibleViewPanel;
                },
                openView: function(view) {
                    if (view == 'list') {
                        this.load();
                        this.toggleViewPanel();
                    }
                },
                newMarker: function(latlng) {
                    var options = {
                        icon : L.AwesomeMarkers.icon({icon: 'plus', prefix: 'fa', markerColor: 'red', spin: false})
                    };
                    var marker = L.marker(latlng, options);
                    marker.addTo(this.group);
                    this.getForm(latlng)
                },
                addMarker: function(options) {
                    var category = options.categories;
                    if (category.length != 0) {
                        options.icon = L.AwesomeMarkers.icon({icon: category[0].icon, prefix: 'fa', markerColor: category[0].color, spin: false});
                    } else {
                        options.icon = L.AwesomeMarkers.icon({icon: 'question', prefix: 'fa', markerColor: 'orange', spin: false});
                    }
                    var latlng = L.latLng(options.lat, options.lon);
                    var marker = L.marker(latlng, options);


                    var popup = `<b>${marker.options.title}</b> <i>(${marker.options.status.name})</i><br>`;
                    marker.options.categories.forEach(function(category) {
                        popup += `<br>- ${category.name}`;
                    });
                    var created = new Intl.DateTimeFormat('ru-RU').format(new Date(marker.options.created));
                    popup += `<br><br><div style="color:gray">Создана: ${created}</div>`;
                    marker.bindPopup(popup);
                    marker.on('mouseover', function (e) {
                        this.openPopup();
                    });
                    marker.on('mouseout', function (e) {
                        this.closePopup();
                    });

                    marker.on('click', function(e) {
                        this.getForm(this.getLatLng(), this.options)
                    })
                    marker.addTo(this.group);
                },
                centerMap: function(e) {
                    this.map.panTo(e.latlng);
                },
                zoomIn: function(e) {
                    this.map.zoomIn();
                },
                zoomOut: function(e) {
                    this.map.zoomOut();
                },
                onResize: function() {
                    this.cardStyle.height = window.innerHeight - 36 + 'px';
                    this.viewStyle.height = window.innerHeight - 36 + 'px';
                    this.mapStyle.height = window.innerHeight + 'px';
                },
                forEachLoad: function(callback) {
                    $.get('@api.v1.routes.IssueController.list()', function(data) {
                        data.forEach(callback, vm);
                    });
                },
                load: function(){
                    $.get('@api.v1.routes.IssueController.list()', function(data) {
                        vm.issues = data;
                    });
                },
                getAccess: function(access) {
                    if(access=='Admin'){
                        $.get('@api.v1.routes.ApiController.loginAsAdmin()', function(data) {});
                    } else {
                        $.get('@api.v1.routes.ApiController.loginAsUser()', function(data) {});
                    }
                }
            },
            mounted: function () {
                this.$nextTick(() => {
                    this.popup = new L.Popup();
                    this.layer = new L.TileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                        id: 'mapbox.streets',
                        maxZoom: 18,
                        minZoom: 14,
                        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                        accessToken: 'pk.eyJ1IjoibGZvcmltIiwiYSI6ImNqa2d6eXZ6ejBkNzUza2xod3d6M2Z5dzQifQ.9D55ohFuy_MoCvxW50HSXA'
                    });
                    this.map = new L.Map('map', {
                        center: new L.LatLng(55.438944, 65.339271),
                        zoom: 16,
                        zoomControl: false,
                        layers: [this.layer]
                    });
                    this.group = new L.featureGroup();
                    this.group.addTo(this.map);
                    this.zoom = L.control.zoom({
                        position: 'bottomright'
                    });
                    this.zoom.addTo(this.map);
                    L.DomUtil.addClass(this.map._container, 'crosshair-cursor-default');
                    $(window).on('resize', this.onResize);
                    this.map.on('click', this.pastePoint);
                    $(window).on('mousedown', '.leaflet-container', function(e) {
                        if (e.button == 0 && !this.drawMode) {
                            L.DomUtil.addClass(this.map._container,'crosshair-cursor-drag');
                            L.DomUtil.removeClass(this.map._container,'crosshair-cursor-default');
                        } else if (e.button == 0 && this.drawMode) {
                            L.DomUtil.addClass(this.map._container,'crosshair-cursor-drag');
                            L.DomUtil.removeClass(this.map._container,'crosshair-cursor-default');
                        }
                    });
                    $(window).on('mouseup', '.leaflet-container', function(e) {
                        if (e.button == 0 && !this.drawMode) {
                            L.DomUtil.removeClass(this.map._container,'crosshair-cursor-drag');
                            L.DomUtil.addClass(this.map._container,'crosshair-cursor-default');
                        } else if (e.button == 0 && this.drawMode) {
                            L.DomUtil.addClass(this.map._container,'crosshair-cursor-drag');
                            L.DomUtil.removeClass(this.map._container,'crosshair-cursor-default');
                        }
                    });
                    this.onResize();
                    setInterval(function(vm) {
                        vm.map.invalidateSize();
                    }, 250, this);
                    this.forEachLoad(function(marker) {
                        this.addMarker(marker);
                    });
                });
            }
        });
    </script>
}
